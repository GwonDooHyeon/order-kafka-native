# Stage 1: íŒŒí‹°ì…˜ 3ê°œ + í‚¤ ê¸°ë°˜ ë¼ìš°íŒ…

## íŒŒí‹°ì…˜ ì „ëµ (í‚¤ê°€ nullì¼ ë•Œ)

| Kafka ë²„ì „   | ì „ëµ                     | ë™ì‘                          |
|------------|------------------------|-----------------------------|
| **2.3 ì´í•˜** | Round Robin            | ë©”ì‹œì§€ë§ˆë‹¤ íŒŒí‹°ì…˜ ë³€ê²½ (0â†’1â†’2â†’0â†’1...) |
| **2.4 ì´ìƒ** | **Sticky Partitioner** | ê°™ì€ ë°°ì¹˜ ë‚´ì—ì„  ê°™ì€ íŒŒí‹°ì…˜ ìœ ì§€         |

**Sticky Partitionerê°€ ë„ì…ëœ ì´ìœ :**

- ë¼ìš´ë“œ ë¡œë¹ˆì€ ë©”ì‹œì§€ë§ˆë‹¤ íŒŒí‹°ì…˜ì´ ë°”ë€œ â†’ ë°°ì¹˜ ë°ì´í„°ë¥¼ ë¹¨ë¦¬ ì±„ìš°ì§€ ëª»í•˜ë©´ì„œ ì „ì†¡ì´ ëŠ¦ì–´ì§€ê±°ë‚˜ ë°°ì¹˜ë¥¼ ë‹¤ ì±„ìš°ì§€ ëª»í•˜ê³  ì „ì†¡ í•˜ë©´ì„œ ì „ì†¡ ì„±ëŠ¥ì´ ë–¨ì–´ì§€ëŠ” ë¬¸ì œ ë°œìƒ
- StickyëŠ” `linger.ms` ë™ì•ˆ ê°™ì€ íŒŒí‹°ì…˜ì— ëª¨ì•„ì„œ ë°°ì¹˜ ì „ì†¡ â†’ ì²˜ë¦¬ëŸ‰ í–¥ìƒ

**ì˜ˆì‹œ**

```
Round Robin: msg1â†’P0, msg2â†’P1, msg3â†’P2, msg4â†’P0 (ìˆœí™˜)
Sticky:      msg1â†’P0, msg2â†’P0, msg3â†’P0 (ë°°ì¹˜) â†’ msg4â†’P1 (ìƒˆ ë°°ì¹˜)
```

**Sticky Partitioner ë™ì‘ íë¦„ (batch.size = 16KB):**

```
Sticky Partitionerì˜ ë™ì‘ íë¦„:

â”Œâ”€ Partition 0 (Sticky) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Message 1 (25 bytes)                           â”‚
â”‚  Message 2 (25 bytes)                           â”‚
â”‚  ... ê³„ì† ê°™ì€ íŒŒí‹°ì…˜...                         â”‚
â”‚  Message 654 (25 bytes)                         â”‚
â”‚  ì´ ëˆ„ì  í¬ê¸°: ~16,350 bytes â†’ ë°°ì¹˜ ì´ˆê³¼!      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ ë°°ì¹˜ í”ŒëŸ¬ì‹œ (Flush)

â”Œâ”€ Partition 1 (ìƒˆë¡œìš´ Sticky) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Message 655 (25 bytes)                        â”‚
â”‚  Message 656 (25 bytes)                        â”‚
â”‚  ... ê³„ì† ê°™ì€ íŒŒí‹°ì…˜...                        â”‚
â”‚  Message 1308 (25 bytes)                       â”‚
â”‚  ì´ ëˆ„ì  í¬ê¸°: ~16,350 bytes â†’ ë°°ì¹˜ ì´ˆê³¼!     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ ë°°ì¹˜ í”ŒëŸ¬ì‹œ

â”Œâ”€ Partition 2 (ìƒˆë¡œìš´ Sticky) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Message 1309 (25 bytes)                       â”‚
â”‚  ... ë°˜ë³µ                                      â”‚
```

**í•µì‹¬ ì„¤ì •:**

| ì„¤ì •             | ê¸°ë³¸ê°’          | ì—­í•                              |
|----------------|--------------|--------------------------------|
| **batch.size** | 16,384 bytes | âš¡ ë°°ì¹˜ í¬ê¸° í•œê³„ (ë„ë‹¬í•˜ë©´ í”ŒëŸ¬ì‹œ)          |
| **linger.ms**  | 0ms          | â° ë°°ì¹˜ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ìµœëŒ€ ì‹œê°„ (0 = ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ) |

**í”ŒëŸ¬ì‹œ ì¡°ê±´:**

1. `batch.size` ë„ë‹¬ (16,384 bytes) â†’ **ì¦‰ì‹œ í”ŒëŸ¬ì‹œ** ğŸ”¥
2. `linger.ms` ì‹œê°„ ê²½ê³¼ (ê¸°ë³¸ 0ms = ì‚¬ìš© ì•ˆ í•¨)
3. `producer.flush()` ëª…ì‹œì  í˜¸ì¶œ
4. `producer.close()` ë˜ëŠ” JVM ì¢…ë£Œ

---

## íŒŒí‹°ì…˜ ì „ëµ (í‚¤ê°€ ìˆì„ ë•Œ)

**í•µì‹¬ ê°œë…:** ê°™ì€ í‚¤ëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡ë¨ (ë©”ì‹œì§€ ìˆœì„œ ë³´ì¥)

| ì „ëµ                   | ë™ì‘                                  | ì‚¬ìš© ëª©ì                        |
|----------------------|-------------------------------------|-----------------------------|
| **Hash Partitioner** | hash(key) % partition_countë¡œ íŒŒí‹°ì…˜ ê²°ì • | ê°™ì€ keyëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ (ìˆœì„œ ë³´ì¥) |

**ì™œ í•„ìš”í•œê°€?**

- ê°™ì€ ì£¼ë¬¸(order_id)ì˜ ëª¨ë“  ì´ë²¤íŠ¸ë¥¼ ê°™ì€ íŒŒí‹°ì…˜ì— ëª¨ìœ¼ë©´ â†’ ìˆœì„œ ë³´ì¥ ê°€ëŠ¥
- keyê°€ ì—†ìœ¼ë©´ ìˆœì„œë¥¼ ë³´ì¥í•  ìˆ˜ ì—†ìŒ (ìŠ¤ì¼€ì¼ë§ ë¬¸ì œ)

**ì˜ˆì‹œ:**

```mermaid
graph TD
    A["Producer"]
    A -->|" Key: order-001 "| B["hash ê³„ì‚°<br/>10 % 3 = 0"]
    A -->|" Key: order-001 "| C["hash ê³„ì‚°<br/>10 % 3 = 0"]
    A -->|" Key: order-002 "| D["hash ê³„ì‚°<br/>7 % 3 = 1"]
    A -->|" Key: order-003 "| E["hash ê³„ì‚°<br/>5 % 3 = 2"]
    B --> F["Partition 0<br/>(order-001ì˜ ëª¨ë“  ë©”ì‹œì§€)"]
    C --> F
    D --> G["Partition 1<br/>(order-002ì˜ ë©”ì‹œì§€)"]
    E --> H["Partition 2<br/>(order-003ì˜ ë©”ì‹œì§€)"]
    style F fill: #ffffcc
    style G fill: #ffffcc
    style H fill: #ffffcc
```

**ì½”ë“œ ì˜ˆì‹œ:**

```java
// ê°™ì€ keyëŠ” í•­ìƒ ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ ì „ì†¡
producer.send(
    new ProducerRecord<>("topic", "order-001","ë©”ì‹œì§€1")  // Partition 0
);
producer.send(
    new ProducerRecord<>("topic", "order-001","ë©”ì‹œì§€2")  // Partition 0 (ê°™ìŒ!)
);
```
